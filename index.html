<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AgriMarket ‚Äî Farmers' Market & Price Platform (Prototype)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåæ</text></svg>">
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#22c55e; --accent-2:#06b6d4; --glass: rgba(255,255,255,0.03);
    --glass-strong: rgba(255,255,255,0.06); --glass-weak: rgba(255,255,255,0.02);
    --radius:14px; --ease:cubic-bezier(.2,.9,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 400px at 10% 10%, rgba(6,182,212,0.06), transparent),
                radial-gradient(900px 300px at 90% 90%, rgba(34,197,94,0.04), transparent),
                linear-gradient(180deg,#081221 0%, #071022 40%, #06121b 100%);
    color:#e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    padding:24px;
  }

  /* Shell */
  .app {
    max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 270px 1fr; gap:20px;
    align-items:start;
  }
  @media (max-width:900px){ .app{ grid-template-columns: 1fr; } }

  .sidebar{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
    border-radius:var(--radius); padding:18px; min-height:420px; box-shadow: 0 8px 30px rgba(2,6,23,0.7);
    backdrop-filter: blur(6px); border:1px solid var(--glass-weak);
  }
  .logo{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .logo .icon{font-size:28px}
  .small{font-size:13px;color:var(--muted)}
  .nav{margin-top:16px; display:flex; flex-direction:column; gap:8px}
  .nav button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:0;background:transparent;color:inherit;cursor:pointer;transition:all .25s var(--ease); font-weight:600}
  .nav button:hover{transform:translateX(6px); color: #fff}
  .nav button.active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: inset 0 -1px 0 rgba(255,255,255,0.02); }

  .card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02)); border-radius:12px;padding:14px;border:1px solid var(--glass); box-shadow: 0 6px 20px rgba(2,6,23,0.5)}
  h2{margin:0 0 10px 0;font-size:18px}
  .sub{font-size:13px;color:var(--muted); margin-bottom:8px}

  /* Header / top controls (main pane) */
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
  .search{display:flex;gap:8px;align-items:center;background:var(--glass); padding:8px;border-radius:10px}
  .search input{background:transparent;border:0;outline:0;color:inherit}
  .userpill{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent), var(--accent-2)); color:#042024; font-weight:700; cursor:pointer; transition:transform .18s var(--ease)}
  .btn:hover{transform:translateY(-3px)}

  /* layout */
  .main{min-height:420px}
  .grid2{display:grid;grid-template-columns:1fr 360px; gap:14px}
  @media (max-width:900px){ .grid2{grid-template-columns:1fr} }

  /* listing cards */
  .listing{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02); transition:transform .18s var(--ease), box-shadow .18s var(--ease)}
  .listing:hover{transform:translateY(-6px); box-shadow: 0 18px 35px rgba(2,6,23,0.6)}
  .thumb{width:96px;height:64px;border-radius:8px;background:linear-gradient(90deg, rgba(34,197,94,0.14), rgba(6,182,212,0.12));display:flex;align-items:center;justify-content:center;font-size:22px}
  .listing .meta{flex:1}
  .tag{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;background:rgba(255,255,255,0.02);font-size:13px}
  .price{font-size:18px;font-weight:800}
  .muted{color:var(--muted);font-size:13px}

  /* forms */
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
  .form-row{display:grid;grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:600px){ .form-row{grid-template-columns:1fr} }

  /* table */
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;text-align:left;font-size:13px;border-bottom:1px dashed rgba(255,255,255,0.02)}
  th{color:var(--muted);font-weight:700}

  /* small UI */
  .chip{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
  .toast{position:fixed;right:22px;bottom:22px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#052024;padding:12px 16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);transform:translateY(20px);opacity:0;transition:all .35s var(--ease)}
  .toast.show{transform:translateY(0);opacity:1}

  /* small animations */
  .fade-in{animation:fadeIn .45s var(--ease) both}
  @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

  .empty{opacity:.7;color:var(--muted);padding:20px;border-radius:10px;background:transparent;text-align:center}

  /* nice header hero */
  .hero{
    display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);
  }
  .stats{display:flex;gap:10px;align-items:center}
  .stat{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);min-width:120px}
  .stat h3{margin:0;font-size:16px}
  .stat p{margin:4px 0 0 0;color:var(--muted);font-size:13px}

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.4);display:flex;align-items:center;justify-content:center;z-index:60;backdrop-filter: blur(3px)}
  .modal{width:720px;max-width:94%;background:linear-gradient(180deg,#071122,#0a1620);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  @media(max-width:600px){ .modal{width:94%} }

  /* small helpers */
  .row{display:flex;gap:10px;align-items:center}
  .muted-2{color:rgba(255,255,255,0.6)}
  .small-btn{padding:6px 8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);cursor:pointer}
  .flex-col{display:flex;flex-direction:column;gap:8px}
</style>
</head>
<body>
  <div class="app fade-in" id="app">
    <aside class="sidebar card" aria-label="Sidebar">
      <div class="logo">
        <div class="icon">üåæ</div>
        <div>
          <div style="font-weight:800">AgriMarket</div>
          <div class="small">Farmer ‚Üî Buyer ‚Ä¢ Prototype</div>
        </div>
      </div>

      <div class="card" style="padding:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800" id="user-name">Guest</div>
            <div class="small">Not signed in</div>
          </div>
          <div>
            <button class="small-btn" id="btn-signin">Sign in</button>
          </div>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <button class="active" data-view="market">üè™ Market</button>
        <button data-view="farmer">üë©‚Äçüåæ Farmer Dashboard</button>
        <button data-view="buyer">üßë‚Äçüíº Buyer Dashboard</button>
        <button data-view="admin">üõ† Admin</button>
        <button data-view="help">‚ùì Help</button>
      </nav>

      <div style="margin-top:14px" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Pilot Area</div>
            <div style="font-weight:800">Sample Village</div>
          </div>
          <div class="chip">Beta</div>
        </div>
        <div style="margin-top:10px" class="small">Use the sign-in button to simulate farmer/buyer sign-in. Data persists in browser storage.</div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="search card" style="padding:8px 12px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="rgba(255,255,255,0.6)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="rgba(255,255,255,0.6)" stroke-width="1.6"/></svg>
          <input id="global-search" placeholder="Search crops, village, price..." />
          <div style="width:12px"></div>
        </div>
        <div class="userpill">
          <div class="card" style="padding:8px 12px;">
            <div style="display:flex;gap:10px;align-items:center">
              <div class="chip" id="role-badge">Guest</div>
              <div class="small muted-2" id="signedphone">‚Äî</div>
            </div>
          </div>
          <button class="btn" id="open-create">+ Create Listing</button>
        </div>
      </div>

      <section id="view-market" class="fade-in">
        <div class="hero card">
          <div>
            <h2>Live Marketplace</h2>
            <div class="sub">Browse current farmer listings ‚Äî connect directly and make offers.</div>
            <div style="margin-top:10px;color:var(--muted)">Tip: Use filters on the right to narrow by crop, price and location.</div>
          </div>
          <div class="stats">
            <div class="stat">
              <h3 id="stat-users">0 users</h3>
              <p>Registered users</p>
            </div>
            <div class="stat">
              <h3 id="stat-listings">0 listings</h3>
              <p>Active listings</p>
            </div>
            <div class="stat">
              <h3 id="stat-volume">0 kg</h3>
              <p>Listed volume</p>
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="grid2">
          <div>
            <div id="listings-container"></div>
            <div id="empty-market" class="empty" style="display:none">No listings yet ‚Äî farmers can create listings using the "Create Listing" button.</div>
          </div>

          <aside>
            <div class="card">
              <h3>Filters</h3>
              <div style="margin-top:8px" class="flex-col">
                <label>Crop</label>
                <select id="filter-crop"><option value="">All</option></select>
                <label>Location</label>
                <select id="filter-village"><option value="">All</option></select>
                <label>Max Price ‚Çπ/kg</label>
                <input id="filter-price" placeholder="e.g., 30" />
                <label>Sort</label>
                <select id="filter-sort">
                  <option value="new">Newest</option>
                  <option value="price-asc">Price ‚Üë</option>
                  <option value="price-desc">Price ‚Üì</option>
                </select>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="small-btn" id="apply-filters">Apply</button>
                  <button class="small-btn" id="clear-filters">Clear</button>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>Notifications</h3>
              <div id="notifications" style="max-height:220px;overflow:auto"></div>
              <div style="text-align:right;margin-top:8px"><button class="small-btn" id="clear-notifs">Clear</button></div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Farmer dashboard -->
      <section id="view-farmer" style="display:none">
        <div class="hero card">
          <div>
            <h2>Farmer Dashboard</h2>
            <div class="sub">Create listings, view incoming offers and track your sales.</div>
          </div>
          <div>
            <button class="btn" id="farmer-create">+ New Listing</button>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="grid2">
          <div>
            <div class="card">
              <h3>My Listings</h3>
              <div id="farmer-listings" style="margin-top:10px"></div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>Incoming Offers</h3>
              <div id="incoming-offers" style="margin-top:10px"></div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>Sales History</h3>
              <table id="sales-history" style="margin-top:8px"><thead><tr><th>Date</th><th>Crop</th><th>Qty</th><th>Price/kg</th><th>Buyer</th></tr></thead><tbody></tbody></table>
            </div>
          </div>

          <aside>
            <div class="card">
              <h3>Profile</h3>
              <div style="margin-top:8px">
                <label>Name</label>
                <input id="profile-name" />
                <label>Village</label>
                <input id="profile-village" />
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="small-btn" id="save-profile">Save</button>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>Quick Tips</h3>
              <div class="small muted" style="line-height:1.5">
                ‚Ä¢ Upload clear photos for better buyer trust.<br/>
                ‚Ä¢ Set realistic ask price and mark ‚Äúopen to offers‚Äù if flexible.<br/>
                ‚Ä¢ Use the notifications to respond quickly.
              </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Buyer dashboard -->
      <section id="view-buyer" style="display:none">
        <div class="hero card">
          <div>
            <h2>Buyer Dashboard</h2>
            <div class="sub">Search listings, place offers and confirm orders quickly.</div>
          </div>
          <div>
            <div class="small muted">Logged as buyer</div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="grid2">
          <div>
            <div class="card">
              <h3>Search Results</h3>
              <div id="buyer-listings"></div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>My Offers</h3>
              <div id="buyer-offers" style="margin-top:8px"></div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>Orders Confirmed</h3>
              <table id="buyer-orders"><thead><tr><th>Date</th><th>Crop</th><th>Qty</th><th>Price</th><th>Farmer</th></tr></thead><tbody></tbody></table>
            </div>
          </div>

          <aside>
            <div class="card">
              <h3>Saved Filters & Alerts</h3>
              <div class="small muted">(Prototype) Save alerts to get notified when matching listings appear.</div>
              <div style="margin-top:8px">
                <label>Crop</label>
                <input id="alert-crop" placeholder="e.g., Tomato" />
                <label>Minimum qty (kg)</label>
                <input id="alert-minqty" placeholder="e.g., 200" />
                <div style="display:flex;gap:8px;margin-top:8px"><button class="small-btn" id="save-alert">Save</button></div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>Buyer Profile</h3>
              <label>Name / Shop</label><input id="buyer-name" />
              <label>Location</label><input id="buyer-location" />
              <div style="margin-top:8px"><button class="small-btn" id="save-buyer">Save</button></div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Admin view -->
      <section id="view-admin" style="display:none">
        <div class="hero card">
          <div>
            <h2>Admin Panel</h2>
            <div class="sub">Monitor platform status during pilot.</div>
          </div>
          <div>
            <button class="btn" id="admin-reset">Reset Data</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="grid2">
          <div>
            <div class="card">
              <h3>Users</h3>
              <table id="admin-users"><thead><tr><th>Phone</th><th>Role</th><th>Name</th><th>Village</th></tr></thead><tbody></tbody></table>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>Listings</h3>
              <div id="admin-listings"></div>
            </div>
          </div>

          <aside>
            <div class="card">
              <h3>Summary</h3>
              <div style="margin-top:8px">
                <div class="small">Total Users: <strong id="admin-total-users">0</strong></div>
                <div class="small">Total Listings: <strong id="admin-total-listings">0</strong></div>
                <div class="small">Total Volume (kg): <strong id="admin-total-volume">0</strong></div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <h3>Platform Notes</h3>
              <div class="small muted">This admin area helps during the pilot to review activity.</div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Help view -->
      <section id="view-help" style="display:none">
        <div class="card hero">
          <div>
            <h2>Help & How-to</h2>
            <div class="sub">Quick guide to use the prototype</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h3>Getting started</h3>
          <ol>
            <li>Click <strong>Sign in</strong> and simulate a Farmer or Buyer account (OTP simulated).</li>
            <li>Farmers click <strong>Create Listing</strong> and add details.</li>
            <li>Buyers browse listings and make offers.</li>
            <li>Farmers accept offers ‚Üí sale moves to Sales History and Orders Confirmed.</li>
          </ol>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h3>Notes for real deployment</h3>
          <ul>
            <li>Replace simulated OTP with real SMS gateway (Twilio / MSG91 / TextLocal).</li>
            <li>Use real database (Postgres / Firebase) and server for durability and security.</li>
            <li>Add payment (UPI) or escrow services for safe transactions.</li>
            <li>Localize UI into regional language(s) and add SMS/USSD fallback.</li>
          </ul>
        </div>
      </section>

    </main>
  </div>

  <!-- Modal for create listing + offers -->
  <div id="modal-root" style="display:none"></div>

  <div id="toast" class="toast">Saved!</div>

<script>
/*
  AgriMarket Prototype (front-end only)
  - Uses localStorage for persistence (keys: am_users, am_listings, am_offers, am_orders, am_notifs)
  - Roles: farmer, buyer, admin
  - Simulated OTP sign-in
  - Comments mark where a backend would be used
*/

// ----------------- Utilities -----------------
const uid = ()=> 'id'+Math.random().toString(36).slice(2,9);
const nowISO = ()=> new Date().toISOString();
const toast = (txt)=> { const t=document.getElementById('toast'); t.textContent=txt; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2600); }

// storage helpers
const storage = {
  get(k, def){ try { const raw=localStorage.getItem(k); return raw? JSON.parse(raw): def }, catch(e){return def} },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
};

// app state: load or initialize
let users = storage.get('am_users', []);
let listings = storage.get('am_listings', []);
let offers = storage.get('am_offers', []);
let orders = storage.get('am_orders', []);
let notifs = storage.get('am_notifs', []);
let currentUser = storage.get('am_currentUser', null);
let alerts = storage.get('am_alerts', []);

// add an admin by default (for demo)
if(!users.find(u=>u.role==='admin')) {
  users.push({id:uid(), phone:'0000000000', role:'admin', name:'Platform Admin', village:'Central'});
  storage.set('am_users', users);
}

// ----------------- DOM refs -----------------
const views = {
  market: document.getElementById('view-market'),
  farmer: document.getElementById('view-farmer'),
  buyer: document.getElementById('view-buyer'),
  admin: document.getElementById('view-admin'),
  help: document.getElementById('view-help'),
};
const navBtns = document.querySelectorAll('.nav button');
const userNameEl = document.getElementById('user-name');
const roleBadge = document.getElementById('role-badge');
const signedPhone = document.getElementById('signedphone');
const btnSignin = document.getElementById('btn-signin');
const openCreateBtn = document.getElementById('open-create');
const globalSearch = document.getElementById('global-search');
const listingsContainer = document.getElementById('listings-container');
const filterCrop = document.getElementById('filter-crop');
const filterVillage = document.getElementById('filter-village');
const filterPrice = document.getElementById('filter-price');
const filterSort = document.getElementById('filter-sort');
const applyFilters = document.getElementById('apply-filters');
const clearFilters = document.getElementById('clear-filters');
const notificationsEl = document.getElementById('notifications');

const farmerListingsEl = document.getElementById('farmer-listings');
const incomingOffersEl = document.getElementById('incoming-offers');
const salesHistoryTbody = document.querySelector('#sales-history tbody');
const profileName = document.getElementById('profile-name');
const profileVillage = document.getElementById('profile-village');
const saveProfileBtn = document.getElementById('save-profile');

const buyerListingsEl = document.getElementById('buyer-listings');
const buyerOffersEl = document.getElementById('buyer-offers');
const buyerOrdersTbody = document.querySelector('#buyer-orders tbody');
const saveAlertBtn = document.getElementById('save-alert');

const adminUsersTbody = document.querySelector('#admin-users tbody');
const adminListingsEl = document.getElementById('admin-listings');
const adminTotalUsers = document.getElementById('admin-total-users');
const adminTotalListings = document.getElementById('admin-total-listings');
const adminTotalVolume = document.getElementById('admin-total-volume');
const adminResetBtn = document.getElementById('admin-reset');

const statUsers = document.getElementById('stat-users');
const statListings = document.getElementById('stat-listings');
const statVolume = document.getElementById('stat-volume');

const emptyMarket = document.getElementById('empty-market');

// ----------------- Initialization & helpers -----------------
function saveAll(){ storage.set('am_users', users); storage.set('am_listings', listings); storage.set('am_offers', offers); storage.set('am_orders', orders); storage.set('am_notifs', notifs); storage.set('am_currentUser', currentUser); storage.set('am_alerts', alerts); }
function ensureSampleData(){
  if(listings.length===0 && users.length>1){
    const farmer1 = users.find(u=>u.role==='farmer') || (users.push({id:uid(), phone:'8888880001',role:'farmer',name:'Ram Kumar',village:'Sample Village'}) && users[users.length-1]);
    const farmer2 = users.find(u=>u.role==='farmer' && u.phone!=='8888880001') || (users.push({id:uid(), phone:'8888880002',role:'farmer',name:'Sita Devi',village:'Sample Village'}) && users[users.length-1]);
    listings.push({ id:uid(), userId:farmer1.id, crop:'Tomato', qty:300, grade:'A', ask:18, village:'Sample Village', available: new Date().toISOString(), status:'open', createdAt:nowISO(), photo:null });
    listings.push({ id:uid(), userId:farmer2.id, crop:'Onion', qty:250, grade:'B', ask:22, village:'Neighbor Village', available: new Date().toISOString(), status:'open', createdAt:nowISO(), photo:null });
    saveAll();
  }
}
ensureSampleData();

// ----------------- UI: view switching -----------------
function showView(name){
  Object.keys(views).forEach(k=> views[k].style.display = (k===name ? 'block' : 'none'));
  navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.view===name));
  // update header create button visibility
  if(name==='farmer' || name==='buyer' || name==='market') document.getElementById('open-create').style.display='inline-block';
  else document.getElementById('open-create').style.display='none';
  renderAll();
}
document.querySelectorAll('.nav button').forEach(btn=> btn.addEventListener('click', e=> showView(btn.dataset.view)));
showView('market');

// ----------------- Auth (simulated OTP) -----------------
btnSignin.addEventListener('click', ()=> {
  showSignInModal();
});

function showSignInModal(){
  const modal = createModal(`<h3>Sign in (simulated)</h3>
    <div class="small muted">Enter phone number to sign in as Farmer/Buyer. OTP is simulated.</div>
    <div style="height:8px"></div>
    <label>Phone</label><input id="signin-phone" placeholder="10-digit phone" />
    <label>Role</label>
    <select id="signin-role"><option value="farmer">Farmer</option><option value="buyer">Buyer</option><option value="admin">Admin (demo)</option></select>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="send-otp">Send OTP</button>
      <button class="small-btn" id="close-modal">Cancel</button>
    </div>
  `);

  modal.querySelector('#send-otp').addEventListener('click', ()=>{
    const phone = modal.querySelector('#signin-phone').value.trim();
    const role = modal.querySelector('#signin-role').value;
    if(!/^\d{10}$/.test(phone)){ alert('Enter 10-digit phone'); return; }
    // simulate sending OTP -> just display OTP modal
    const otp = Math.floor(1000 + Math.random()*9000);
    // in real: send OTP via SMS gateway, then verify
    modal.remove();
    showOTPModal(phone, role, otp);
  });
}

function showOTPModal(phone, role, otp){
  const modal = createModal(`<h3>Enter OTP</h3>
    <div class="small muted">We simulated sending OTP: <strong>${otp}</strong> (in production this will be sent by SMS).</div>
    <div style="height:8px"></div>
    <label>OTP</label><input id="otp-code" placeholder="Enter code" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="verify-otp">Verify & Sign in</button>
      <button class="small-btn" id="close-modal">Cancel</button>
    </div>`);

  modal.querySelector('#verify-otp').addEventListener('click', ()=>{
    const code = modal.querySelector('#otp-code').value.trim();
    if(code===String(otp)){
      // either find existing or create new user
      let u = users.find(x=>x.phone===phone && x.role===role);
      if(!u){
        u = {id:uid(), phone, role, name: (role==='farmer' ? 'Farmer '+phone.slice(-3) : 'Buyer '+phone.slice(-3)), village:'Sample Village'};
        users.push(u);
      }
      currentUser = u;
      saveAll();
      toast('Signed in as '+u.role);
      renderUserInfo();
      modal.remove();
      showView(u.role==='farmer' ? 'farmer' : (u.role==='buyer' ? 'buyer' : 'admin'));
    } else alert('Incorrect OTP entered. (It was '+otp+')');
  });
}

// ----------------- Modal helper -----------------
function createModal(innerHTML){
  const root = document.getElementById('modal-root');
  root.innerHTML = `<div class="modal-back"><div class="modal">${innerHTML}</div></div>`;
  root.style.display='block';
  root.querySelector('#close-modal')?.addEventListener('click', ()=> { root.innerHTML=''; root.style.display='none' });
  // click outside to close
  root.querySelector('.modal-back').addEventListener('click', (ev)=>{ if(ev.target.classList.contains('modal-back')) { root.innerHTML=''; root.style.display='none' }});
  return root.querySelector('.modal');
}

// ----------------- Render header/user info -----------------
function renderUserInfo(){
  if(currentUser){ userNameEl.textContent = currentUser.name || 'User'; roleBadge.textContent = currentUser.role.toUpperCase(); signedPhone.textContent = currentUser.phone; btnSignin.textContent = 'Sign out'; }
  else { userNameEl.textContent = 'Guest'; roleBadge.textContent = 'Guest'; signedPhone.textContent = '‚Äî'; btnSignin.textContent = 'Sign in'; }
}
renderUserInfo();

// sign out behavior
btnSignin.addEventListener('click', ()=> {
  if(currentUser) { if(confirm('Sign out?')) { currentUser=null; storage.set('am_currentUser', null); renderUserInfo(); showView('market'); toast('Signed out'); } }
  else showSignInModal();
});

// ----------------- Create listing modal -----------------
openCreateBtn.addEventListener('click', ()=> {
  if(!currentUser) { alert('Please sign in as Farmer to create listings.'); showSignInModal(); return; }
  if(currentUser.role!=='farmer') { alert('Only Farmers can create listings. Sign in as Farmer.'); return; }
  showCreateListingModal();
});
document.getElementById('farmer-create').addEventListener('click', ()=> {
  if(!currentUser || currentUser.role!=='farmer'){ alert('Sign in as Farmer'); showSignInModal(); return; }
  showCreateListingModal();
});

function showCreateListingModal(existing){
  const modal = createModal(`<h3>${existing ? 'Edit' : 'Create'} Listing</h3>
    <div class="form-row">
      <div><label>Crop</label><input id="fld-crop" placeholder="e.g., Tomato" /></div>
      <div><label>Grade</label><input id="fld-grade" placeholder="e.g., A / B" /></div>
    </div>
    <div class="form-row" style="margin-top:8px">
      <div><label>Quantity (kg)</label><input id="fld-qty" placeholder="e.g., 200" /></div>
      <div><label>Ask Price (‚Çπ/kg)</label><input id="fld-ask" placeholder="e.g., 25" /></div>
    </div>
    <label>Available Date</label><input id="fld-date" type="date" />
    <label>Village / Location</label><input id="fld-village" placeholder="Village name" />
    <label>Notes / Photo URL (optional)</label><input id="fld-photo" placeholder="HTTP URL or leave blank" />
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="save-listing">${existing? 'Save':'Create'}</button><button class="small-btn" id="close-modal">Cancel</button></div>`);

  // populate if editing
  if(existing){
    modal.querySelector('#fld-crop').value = existing.crop;
    modal.querySelector('#fld-grade').value = existing.grade;
    modal.querySelector('#fld-qty').value = existing.qty;
    modal.querySelector('#fld-ask').value = existing.ask;
    modal.querySelector('#fld-date').value = existing.available ? existing.available.split('T')[0] : '';
    modal.querySelector('#fld-village').value = existing.village;
    modal.querySelector('#fld-photo').value = existing.photo || '';
  } else {
    modal.querySelector('#fld-village').value = currentUser.village || '';
    modal.querySelector('#fld-date').value = (new Date()).toISOString().slice(0,10);
  }

  modal.querySelector('#save-listing').addEventListener('click', ()=>{
    const crop = modal.querySelector('#fld-crop').value.trim();
    const grade = modal.querySelector('#fld-grade').value.trim() || 'A';
    const qty = Number(modal.querySelector('#fld-qty').value.trim());
    const ask = Number(modal.querySelector('#fld-ask').value.trim());
    const available = modal.querySelector('#fld-date').value;
    const village = modal.querySelector('#fld-village').value.trim() || currentUser.village || 'Unknown';
    const photo = modal.querySelector('#fld-photo').value.trim() || null;
    if(!crop || !qty || !ask){ alert('Crop, qty and ask price are required'); return; }

    if(existing){
      existing.crop=crop; existing.grade=grade; existing.qty=qty; existing.ask=ask; existing.village=village; existing.available=available; existing.photo=photo;
    } else {
      listings.unshift({ id:uid(), userId:currentUser.id, crop, grade, qty, ask, village, available, status:'open', createdAt:nowISO(), photo });
    }
    saveAll();
    modal.parentElement.remove(); document.getElementById('modal-root').style.display='none';
    toast('Listing saved');
    notifyBuyersForAlert({crop, qty, village});
    renderAll();
  });
}

// --------------- Rendering listings on Market ---------------
function buildListingCard(l){
  const farmer = users.find(u=>u.id===l.userId);
  const div = document.createElement('div'); div.className='listing';
  div.innerHTML = `<div class="thumb">${l.crop[0]||'C'}</div>
    <div class="meta">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div style="font-weight:800">${l.crop} <span class="muted" style="font-weight:600">‚Ä¢ ${l.grade}</span></div>
          <div class="muted">${l.qty} kg ‚Ä¢ ${l.village} ‚Ä¢ Posted ${timeAgo(l.createdAt)}</div>
        </div>
        <div style="text-align:right">
          <div class="price">‚Çπ ${l.ask}/kg</div>
          <div class="muted">Seller: ${farmer? farmer.name: 'Unknown'}</div>
        </div>
      </div>
    </div>
  `;
  const actions = document.createElement('div');
  actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
  const btnOffer = document.createElement('button'); btnOffer.className='small-btn'; btnOffer.textContent='Make Offer';
  btnOffer.addEventListener('click', ()=> showMakeOfferModal(l));
  const btnContact = document.createElement('button'); btnContact.className='small-btn'; btnContact.textContent='View Details';
  btnContact.addEventListener('click', ()=> showListingDetailsModal(l));
  actions.appendChild(btnOffer); actions.appendChild(btnContact);
  div.appendChild(actions);
  return div;
}

function renderMarketList(filtered){
  const container = listingsContainer;
  container.innerHTML='';
  const open = filtered.filter(l=> l.status==='open');
  if(open.length===0){ emptyMarket.style.display='block'; return; }
  emptyMarket.style.display='none';
  open.forEach(l=>{
    container.appendChild(buildListingCard(l));
    container.appendChild(document.createElement('div'));
  });
}

// --------------- Make Offer flow ---------------
function showMakeOfferModal(listing){
  if(!currentUser){ alert('Sign in as Buyer to make offer.'); showSignInModal(); return; }
  if(currentUser.role!=='buyer'){ alert('Sign in as Buyer to make offer.'); return; }
  const farmer = users.find(u=>u.id===listing.userId);
  const modal = createModal(`<h3>Make Offer for ${listing.crop}</h3>
    <div class="small muted">Seller: ${farmer? farmer.name: 'Unknown'} ‚Ä¢ ${listing.village}</div>
    <div style="height:8px"></div>
    <label>Quantity to buy (kg)</label><input id="offer-qty" value="${Math.min(20,listing.qty)}" />
    <label>Offer Price (‚Çπ/kg)</label><input id="offer-price" value="${listing.ask}" />
    <label>Pickup date</label><input id="offer-date" type="date" value="${new Date().toISOString().slice(0,10)}" />
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="send-off">Send Offer</button><button class="small-btn" id="close-modal">Cancel</button></div>`);

  modal.querySelector('#send-off').addEventListener('click', ()=>{
    const qty = Number(modal.querySelector('#offer-qty').value.trim());
    const price = Number(modal.querySelector('#offer-price').value.trim());
    const date = modal.querySelector('#offer-date').value;
    if(!qty || !price){ alert('Enter qty and price'); return; }
    const o = { id:uid(), listingId:listing.id, buyerId:currentUser.id, offerPrice:price, qtyOffered:qty, pickupDate:date, status:'pending', createdAt:nowISO() };
    offers.unshift(o); saveAll();
    addNotification(listing.userId, `New offer for your ${listing.crop}: ‚Çπ${price}/kg for ${qty} kg.`);
    toast('Offer sent');
    modal.parentElement.remove(); document.getElementById('modal-root').style.display='none';
    renderAll();
  });
}

// --------------- Listing details modal ---------------
function showListingDetailsModal(listing){
  const farmer = users.find(u=>u.id===listing.userId);
  const html = `<h3>${listing.crop} ‚Ä¢ ${listing.village}</h3>
    <div class="small muted">Seller: ${farmer? farmer.name: 'Unknown'} ‚Ä¢ Grade: ${listing.grade}</div>
    <div style="height:8px"></div>
    <div style="display:flex;gap:10px;align-items:center">
      <div style="min-width:120px">
        <div class="thumb" style="width:160px;height:98px;font-size:36px">${listing.crop[0]}</div>
      </div>
      <div style="flex:1">
        <div style="font-weight:800;font-size:20px">‚Çπ ${listing.ask}/kg</div>
        <div class="muted" style="margin-top:6px">${listing.qty} kg available ‚Ä¢ Available from: ${listing.available ? listing.available.split('T')[0] : 'Now'}</div>
        <div style="margin-top:8px">${listing.photo ? `<div class="small muted">Photo: <a href="${listing.photo}" target="_blank">${listing.photo}</a></div>` : ''}</div>
      </div>
    </div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:8px"><button class="btn" id="dlg-offer">Make Offer</button><button class="small-btn" id="close-modal">Close</button></div>`;

  const modal = createModal(html);
  modal.querySelector('#dlg-offer').addEventListener('click', ()=> { modal.remove(); document.getElementById('modal-root').style.display='none'; showMakeOfferModal(listing); });
}

// --------------- Farmer: incoming offers & accept/reject ---------------
function renderIncomingOffers(){
  if(!currentUser || currentUser.role!=='farmer'){ incomingOffersEl.innerHTML='<div class="empty">Sign in as farmer to see incoming offers.</div>'; return; }
  const myListingsIds = listings.filter(l=>l.userId===currentUser.id).map(l=>l.id);
  const myOffers = offers.filter(o=> myListingsIds.includes(o.listingId));
  if(myOffers.length===0){ incomingOffersEl.innerHTML='<div class="empty">No offers yet.</div>'; return; }
  incomingOffersEl.innerHTML='';
  myOffers.forEach(o=>{
    const listing = listings.find(l=>l.id===o.listingId);
    const buyer = users.find(u=>u.id===o.buyerId);
    const div = document.createElement('div'); div.className='listing';
    div.innerHTML = `<div style="flex:1">
      <div style="font-weight:800">${listing.crop} ‚Ä¢ ${o.qtyOffered} kg</div>
      <div class="muted">Offer ‚Çπ ${o.offerPrice}/kg ‚Ä¢ From: ${buyer? buyer.name: 'Buyer'}</div>
      <div class="muted">Status: ${o.status} ‚Ä¢ Sent ${timeAgo(o.createdAt)}</div>
    </div>`;
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
    const btnAccept = document.createElement('button'); btnAccept.textContent='Accept'; btnAccept.className='small-btn';
    btnAccept.addEventListener('click', ()=> acceptOffer(o));
    const btnReject = document.createElement('button'); btnReject.textContent='Reject'; btnReject.className='small-btn';
    btnReject.addEventListener('click', ()=> { o.status='rejected'; saveAll(); addNotification(o.buyerId, `Your offer for ${listing.crop} was rejected.`); toast('Offer rejected'); renderAll(); });
    actions.appendChild(btnAccept); actions.appendChild(btnReject);
    div.appendChild(actions);
    incomingOffersEl.appendChild(div);
  });
}
function acceptOffer(o){
  // mark offer accepted, create an order, reduce listing qty or close
  o.status='accepted';
  const listing = listings.find(l=>l.id===o.listingId);
  listing.qty = Math.max(0, listing.qty - o.qtyOffered);
  if(listing.qty===0) listing.status='sold';
  orders.unshift({ id:uid(), listingId:listing.id, buyerId:o.buyerId, farmerId:listing.userId, qty:o.qtyOffered, pricePerKg:o.offerPrice, date:nowISO() });
  saveAll();
  addNotification(o.buyerId, `Your offer for ${listing.crop} was accepted! Confirm pickup with the farmer.`);
  addNotification(listing.userId, `You accepted an offer for ${listing.crop} ‚Äî sale recorded.`);
  toast('Offer accepted; order created');
  renderAll();
}

// --------------- Farmer: My listings + sales history ---------------
function renderFarmerListings(){
  if(!currentUser || currentUser.role!=='farmer'){ farmerListingsEl.innerHTML='<div class="empty">Sign in as Farmer to manage listings.</div>'; return; }
  const my = listings.filter(l=>l.userId===currentUser.id);
  if(my.length===0){ farmerListingsEl.innerHTML='<div class="empty">You have no listings yet.</div>'; return; }
  farmerListingsEl.innerHTML='';
  my.forEach(l=>{
    const div = document.createElement('div'); div.className='listing';
    div.innerHTML = `<div style="flex:1">
      <div style="font-weight:800">${l.crop} ‚Ä¢ ${l.qty} kg</div>
      <div class="muted">Ask ‚Çπ${l.ask}/kg ‚Ä¢ ${l.village} ‚Ä¢ ${l.status}</div>
    </div>`;
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
    const btnEdit = document.createElement('button'); btnEdit.textContent='Edit'; btnEdit.className='small-btn';
    btnEdit.addEventListener('click', ()=> showCreateListingModal(l));
    const btnClose = document.createElement('button'); btnClose.textContent='Close Listing'; btnClose.className='small-btn';
    btnClose.addEventListener('click', ()=> { if(confirm('Close this listing?')){ l.status='closed'; saveAll(); renderAll(); toast('Listing closed'); }});
    actions.appendChild(btnEdit); actions.appendChild(btnClose);
    div.appendChild(actions);
    farmerListingsEl.appendChild(div);
  });
}

function renderSalesHistory(){
  if(!currentUser || currentUser.role!=='farmer'){ salesHistoryTbody.innerHTML='<tr><td colspan="5">Sign in as farmer.</td></tr>'; return; }
  const myOrders = orders.filter(o=> o.farmerId===currentUser.id);
  salesHistoryTbody.innerHTML = '';
  if(myOrders.length===0){ salesHistoryTbody.innerHTML = '<tr><td colspan="5" class="empty">No sales yet.</td></tr>'; return; }
  myOrders.forEach(o=>{
    const listing = listings.find(l=>l.id===o.listingId) || { crop:'Unknown' };
    const buyer = users.find(u=>u.id===o.buyerId) || { name:'Buyer' };
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${(new Date(o.date)).toLocaleDateString()}</td><td>${listing.crop}</td><td>${o.qty}</td><td>‚Çπ${o.pricePerKg}/kg</td><td>${buyer.name}</td>`;
    salesHistoryTbody.appendChild(tr);
  });
}

// --------------- Buyer: render search & my offers/orders ---------------
function renderBuyerSearch(filtered){
  if(!currentUser || currentUser.role!=='buyer'){ buyerListingsEl.innerHTML='<div class="empty">Sign in as Buyer to browse listings.</div>'; return; }
  const open = filtered.filter(l=> l.status==='open');
  if(open.length===0){ buyerListingsEl.innerHTML='<div class="empty">No listings found.</div>'; return; }
  buyerListingsEl.innerHTML = '';
  open.forEach(l=>{
    const div = buildListingCard(l);
    buyerListingsEl.appendChild(div);
  });
}

function renderBuyerOffers(){
  if(!currentUser || currentUser.role!=='buyer'){ buyerOffersEl.innerHTML='<div class="empty">Sign in as Buyer to see your offers.</div>'; return; }
  const mine = offers.filter(o=> o.buyerId===currentUser.id);
  if(mine.length===0){ buyerOffersEl.innerHTML = '<div class="empty">No offers yet.</div>'; return; }
  buyerOffersEl.innerHTML = '';
  mine.forEach(o=>{
    const listing = listings.find(l=>l.id===o.listingId) || {};
    const div = document.createElement('div'); div.className='listing';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${listing.crop || 'Unknown'} ‚Ä¢ ${o.qtyOffered} kg</div><div class="muted">Offer ‚Çπ ${o.offerPrice}/kg ‚Ä¢ Status: ${o.status}</div></div>`;
    buyerOffersEl.appendChild(div);
  });
}

function renderBuyerOrders(){
  if(!currentUser || currentUser.role!=='buyer'){ buyerOrdersTbody.innerHTML='<tr><td colspan="5">Sign in as buyer.</td></tr>'; return; }
  const myOrders = orders.filter(o=> o.buyerId===currentUser.id);
  buyerOrdersTbody.innerHTML = '';
  if(myOrders.length===0){ buyerOrdersTbody.innerHTML = '<tr><td colspan="5" class="empty">No orders confirmed yet.</td></tr>'; return; }
  myOrders.forEach(o=>{
    const listing = listings.find(l=>l.id===o.listingId) || { crop:'Unknown' };
    const farmer = users.find(u=>u.id===o.farmerId) || { name:'Farmer' };
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${(new Date(o.date)).toLocaleDateString()}</td><td>${listing.crop}</td><td>${o.qty}</td><td>‚Çπ${o.pricePerKg}/kg</td><td>${farmer.name}</td>`;
    buyerOrdersTbody.appendChild(tr);
  });
}

// --------------- Admin render ---------------
function renderAdmin(){
  adminUsersTbody.innerHTML = '';
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.phone}</td><td>${u.role}</td><td>${u.name||''}</td><td>${u.village||''}</td>`;
    adminUsersTbody.appendChild(tr);
  });

  adminListingsEl.innerHTML = '';
  listings.forEach(l=>{
    const farmer = users.find(u=>u.id===l.userId);
    const d = document.createElement('div'); d.className='listing'; d.innerHTML = `<div style="flex:1"><div style="font-weight:800">${l.crop} ‚Ä¢ ${l.qty} kg</div><div class="muted">Ask ‚Çπ${l.ask} ‚Ä¢ ${l.village} ‚Ä¢ ${l.status}</div></div><div class="muted">${farmer?farmer.name:'Unknown'}</div>`;
    adminListingsEl.appendChild(d);
  });

  adminTotalUsers.textContent = users.length;
  adminTotalListings.textContent = listings.length;
  adminTotalVolume.textContent = listings.reduce((s,l)=>s + (Number(l.qty)||0), 0);
}

// reset demo data
adminResetBtn.addEventListener('click', ()=> {
  if(!confirm('Reset all data? This will clear listings, offers, orders but keep demo admin user.')) return;
  listings=[]; offers=[]; orders=[]; notifs=[]; users = users.filter(u=>u.role==='admin'); currentUser=null; alerts=[];
  saveAll(); renderAll(); toast('Data reset');
});

// --------------- Notifications ---------------
function addNotification(userId, text){
  notifs.unshift({ id:uid(), userId, text, createdAt: nowISO() });
  saveAll();
}
function renderNotifications(){
  notificationsEl.innerHTML='';
  const myNotifs = currentUser ? notifs.filter(n=> n.userId===currentUser.id) : [];
  if(myNotifs.length===0) notificationsEl.innerHTML = '<div class="empty">No notifications.</div>';
  myNotifs.slice(0,20).forEach(n=>{
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px dashed rgba(255,255,255,0.02)';
    d.innerHTML = `<div style="font-weight:700">${n.text}</div><div class="muted" style="font-size:12px">${timeAgo(n.createdAt)}</div>`;
    notificationsEl.appendChild(d);
  });
}
document.getElementById('clear-notifs').addEventListener('click', ()=> {
  if(!currentUser){ alert('Sign in to clear'); return; }
  notifs = notifs.filter(n=> n.userId !== currentUser.id);
  saveAll(); renderNotifications(); toast('Notifications cleared');
});

// ----------------- Alerts (buyer saved alerts) ---------------
document.getElementById('save-alert').addEventListener('click', ()=> {
  if(!currentUser || currentUser.role!=='buyer'){ alert('Sign in as buyer'); return; }
  const crop = document.getElementById('alert-crop').value.trim();
  const minqty = Number(document.getElementById('alert-minqty').value.trim() || 0);
  if(!crop){ alert('Enter crop'); return; }
  alerts.push({ id:uid(), buyerId:currentUser.id, crop, minqty, createdAt:nowISO() });
  saveAll();
  toast('Alert saved ‚Äî you will be notified when matching listings appear');
});
function notifyBuyersForAlert(listing){
  // naive: for any alert matching crop and qty >= minqty -> notify buyer
  alerts.forEach(a=>{
    if(a.crop.toLowerCase() === listing.crop.toLowerCase() && listing.qty >= (a.minqty||0)){
      addNotification(a.buyerId, `Alert: New ${listing.crop} listing ${listing.qty}kg in ${listing.village}.`);
    }
  });
}

// ----------------- Filters & search ---------------
function getFilteredListings(){
  let arr = [...listings];
  const crop = filterCrop.value.trim().toLowerCase();
  const village = filterVillage.value.trim().toLowerCase();
  const price = Number(filterPrice.value.trim()||0);
  const sort = filterSort.value;
  const q = globalSearch.value.trim().toLowerCase();
  if(crop) arr = arr.filter(l=> l.crop.toLowerCase().includes(crop));
  if(village) arr = arr.filter(l=> l.village.toLowerCase().includes(village));
  if(price>0) arr = arr.filter(l=> l.ask <= price);
  if(q) arr = arr.filter(l=> l.crop.toLowerCase().includes(q) || l.village.toLowerCase().includes(q) || String(l.ask).includes(q));
  if(sort==='price-asc') arr.sort((a,b)=> a.ask-b.ask);
  else if(sort==='price-desc') arr.sort((a,b)=> b.ask-a.ask);
  else arr.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
  return arr;
}
applyFilters.addEventListener('click', ()=> renderAll());
clearFilters.addEventListener('click', ()=> { filterCrop.value=''; filterVillage.value=''; filterPrice.value=''; filterSort.value='new'; renderAll(); });

// auto fill crop/village selects
function populateFilterOptions(){
  const crops = Array.from(new Set(listings.map(l=>l.crop))).sort();
  const villages = Array.from(new Set(listings.map(l=>l.village))).sort();
  filterCrop.innerHTML = '<option value="">All</option>';
  crops.forEach(c=> filterCrop.innerHTML += `<option value="${c}">${c}</option>`);
  filterVillage.innerHTML = '<option value="">All</option>';
  villages.forEach(v=> filterVillage.innerHTML += `<option value="${v}">${v}</option>`);
}

// ----------------- small helpers -----------------
function timeAgo(iso){
  if(!iso) return '';
  const diff = (Date.now() - new Date(iso).getTime())/1000;
  if(diff < 60) return `${Math.floor(diff)}s ago`;
  if(diff < 3600) return `${Math.floor(diff/60)}m ago`;
  if(diff < 86400) return `${Math.floor(diff/3600)}h ago`;
  return `${Math.floor(diff/86400)}d ago`;
}

// ----------------- Render all -----------------
function renderAll(){
  saveAll();
  renderUserInfo();
  populateFilterOptions();
  const filtered = getFilteredListings();
  renderMarketList(filtered);
  renderIncomingOffers();
  renderFarmerListings();
  renderSalesHistory();
  renderBuyerSearch(filtered);
  renderBuyerOffers();
  renderBuyerOrders();
  renderAdmin();
  renderNotifications();

  // update stats
  statUsers.textContent = users.length + ' users';
  statListings.textContent = listings.filter(l=> l.status==='open').length + ' listings';
  statVolume.textContent = listings.reduce((s,l)=> s + (Number(l.qty)||0), 0) + ' kg';
}
renderAll();

// ----------------- Utility: show listing details quick -----------------
globalSearch.addEventListener('keydown', (e)=> { if(e.key==='Enter') renderAll(); });

// ----------------- Save profile changes ---------------
saveProfileBtn.addEventListener('click', ()=>{
  if(!currentUser || currentUser.role!=='farmer'){ alert('Sign in as Farmer'); return; }
  currentUser.name = profileName.value.trim() || currentUser.name;
  currentUser.village = profileVillage.value.trim() || currentUser.village;
  const idx = users.findIndex(u=>u.id===currentUser.id);
  if(idx>=0) users[idx]=currentUser;
  saveAll();
  toast('Profile saved');
  renderAll();
});
document.getElementById('save-buyer').addEventListener('click', ()=>{
  if(!currentUser || currentUser.role!=='buyer'){ alert('Sign in as buyer'); return; }
  currentUser.name = document.getElementById('buyer-name').value.trim() || currentUser.name;
  currentUser.village = document.getElementById('buyer-location').value.trim() || currentUser.village;
  const idx = users.findIndex(u=>u.id===currentUser.id);
  if(idx>=0) users[idx]=currentUser;
  saveAll(); toast('Buyer profile saved'); renderAll();
});

// small helper to show modal create listing from search
document.getElementById('open-create').addEventListener('click', ()=> {
  if(!currentUser){ showSignInModal(); return; }
  if(currentUser.role!=='farmer'){ alert('Only farmers can create listings'); return; }
  showCreateListingModal();
});

// notify when new listing matches buyer alerts (simulate)
function simulateBackgroundEvents(){
  // sample: every 30s create a tiny listing (disabled in prototype)
}
// simulateBackgroundEvents();

</script>
</body>
</html>
